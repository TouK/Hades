<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
            http://www.springframework.org/schema/util  http://www.springframework.org/schema/util/spring-util-2.0.xsd
       ">

    <import resource="smx11_quartz_db.xml"/>

    <bean id="DHLITE" class="org.mockito.Mockito" factory-method="mock">
        <constructor-arg value="javax.sql.DataSource"/>
    </bean>

    <bean id="DH" class="org.mockito.Mockito" factory-method="mock">
        <constructor-arg value="javax.sql.DataSource"/>
    </bean>

    <bean id="NASA" class="org.mockito.Mockito" factory-method="mock">
        <constructor-arg value="javax.sql.DataSource"/>
    </bean>

    <bean id="executor" class="java.util.concurrent.Executors" factory-method="newCachedThreadPool" destroy-method="shutdownNow"/>

    <bean id="hadesA" class="pl.touk.hades.sql.timemonitoring.SqlTimeBasedHades">
        <constructor-arg name="mainDataSource" ref="DHLITE"/>
        <constructor-arg name="failoverDataSource" ref="DH"/>
        <constructor-arg name="mainDsName" value="DHLITE"/>
        <constructor-arg name="failoverDsName" value="DH"/>
    </bean>

    <bean id="hadesB" class="pl.touk.hades.sql.timemonitoring.SqlTimeBasedHades">
        <constructor-arg name="mainDataSource" ref="NASA"/>
        <constructor-arg name="failoverDataSource" ref="DH"/>
        <constructor-arg name="mainDsName" value="NASA"/>
        <constructor-arg name="failoverDsName" value="DH"/>
    </bean>

    <bean id="repo" class="pl.touk.hades.sql.timemonitoring.repo.DbSqlTimeRepo" scope="prototype">
        <property name="dataSource" ref="quartzDs"/>
        <property name="connTimeoutMillis" value="1000"/>
        <property name="sqlExecTimeout" value="1"/>
        <property name="sqlExecTimeoutForcingPeriodMillis" value="1000"/>
        <property name="borrowExistingMatchingResultIfYoungerThanMillis" value="5000"/>
        <property name="externalExecutor" ref="executor"/>
    </bean>

    <bean id="calc" class="pl.touk.hades.sql.timemonitoring.SqlTimeCalculatorImpl" scope="prototype">
        <property name="sql" value="SELECT CURRENT_TIMESTAMP"/>
        <property name="sqlExecTimeout" value="2"/>
        <property name="sqlExecTimeoutForcingPeriodMillis" value="2000"/>
        <property name="connTimeoutMillis" value="1000"/>
        <property name="sqlTimeRepo" ref="repo"/>
        <property name="externalExecutor" ref="executor"/>
    </bean>

    <util:properties id="hadesProps_js22_8" location="classpath:integration/quartz_js22_8.properties"/>

    <bean id="schedulerFactory_js22_8" class="org.quartz.impl.StdSchedulerFactory">
        <constructor-arg name="props" ref="hadesProps_js22_8"/>
    </bean>

    <bean id="scheduler" factory-bean="schedulerFactory_js22_8" factory-method="getScheduler"/>

    <bean id="cronA" class="pl.touk.hades.StringFactory" />
    <bean id="cronB" class="pl.touk.hades.StringFactory" />

    <bean id="triggerA" class="pl.touk.hades.sql.timemonitoring.SqlTimeBasedTriggerImpl" init-method="init">
        <constructor-arg name="hades" ref="hadesA"/>
        <constructor-arg name="sqlTimeTriggeringFailoverMillis" value="600"/>
        <constructor-arg name="sqlTimeTriggeringFailbackMillis" value="200"/>
        <constructor-arg name="sqlTimesIncludedInAverage" value="5"/>
        <constructor-arg name="exceptionsIgnoredAfterRecovery" value="true"/>
        <constructor-arg name="recoveryErasesHistoryIfExceptionsIgnoredAfterRecovery" value="false"/>
        <constructor-arg name="sqlTimeCalculator" ref="calc"/>
        <constructor-arg name="currentToUnusedRatio" value="5"/>
        <constructor-arg name="backOffMultiplier" value="3"/>
        <constructor-arg name="backOffMaxRatio" value="15"/>
        <constructor-arg name="cron" ref="cronA"/>
        <constructor-arg name="startDelayMillis" value="0"/>
        <constructor-arg name="syncAttemptDelayMillis" value="1000"/>
        <constructor-arg name="scheduler" ref="scheduler"/>
        <constructor-arg name="syncExecutor" ref="executor"/>
        <constructor-arg name="monitoringMethodDurationHistorySize" value="5"/>
    </bean>

    <bean id="triggerB" class="pl.touk.hades.sql.timemonitoring.SqlTimeBasedTriggerImpl" init-method="init">
        <constructor-arg name="hades" ref="hadesB"/>
        <constructor-arg name="sqlTimeTriggeringFailoverMillis" value="600"/>
        <constructor-arg name="sqlTimeTriggeringFailbackMillis" value="200"/>
        <constructor-arg name="sqlTimesIncludedInAverage" value="5"/>
        <constructor-arg name="exceptionsIgnoredAfterRecovery" value="true"/>
        <constructor-arg name="recoveryErasesHistoryIfExceptionsIgnoredAfterRecovery" value="false"/>
        <constructor-arg name="sqlTimeCalculator" ref="calc"/>
        <constructor-arg name="currentToUnusedRatio" value="5"/>
        <constructor-arg name="backOffMultiplier" value="3"/>
        <constructor-arg name="backOffMaxRatio" value="15"/>
        <constructor-arg name="cron" ref="cronB"/>
        <constructor-arg name="startDelayMillis" value="0"/>
        <constructor-arg name="syncAttemptDelayMillis" value="1000"/>
        <constructor-arg name="scheduler" ref="scheduler"/>
        <constructor-arg name="syncExecutor" ref="executor"/>
        <constructor-arg name="monitoringMethodDurationHistorySize" value="5"/>
    </bean>

</beans>
